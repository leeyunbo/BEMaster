# 동시 요청 - 멀티 쓰레드 
### 쓰레드 
1. 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드
2. 자바 메인 메서드를 실행하면 main이라는 이름의 쓰레드가 실행 
3. 쓰레드는 한번에 하나의 코드 라인만 수행 
4. 동시 처리가 필요하면 쓰레드를 추가로 생성 

### 다중 요청 - 쓰레드 하나 사용 
![image](https://user-images.githubusercontent.com/44944031/113154912-75ca0400-9273-11eb-95ef-720c9848faaa.png)
1. 요청1이 지연되는 경우, 요청2는 쓰레드가 할당될 때 까지 기다리게 됨
2. 결국 둘 다 죽어버리는 상황이 발생 

### 해결책 1. 요청 마다 쓰레드 생성 
1. 요청이 올때마다 쓰레드를 생성하고, 완료 후 쓰레드 제거하는 방법 
2. 장점 
* 동시 요청 처리 OK
* 리소스가 허용될 떄 까지 처리OK
* 하나가 지연되도 나머지는 정상 동작 
3. 단점
* 쓰레드 생성 비용이 매우 비싸, 응답 속도가 느려짐 
* 컨텍스트 스위치 비용이 발생한다. (쓰레드 전환)
* 쓰레드 생성에 제한이 없어, 고객 요청이 너무 많이오면 임계점을 넘어서 서버가 사망할 수 있음 

### 해결책 2. 쓰레드 풀 
![image](https://user-images.githubusercontent.com/44944031/113154919-782c5e00-9273-11eb-833c-5465c4154522.png)
1. 쓰레드 풀에 쓰레드를 미리 생성 
2. 요청이 오면 쓰레드 풀에 쓰레드를 요청
3. 요청 완료 후 쓰레드 풀이 쓰레드 반납 
4. 장점 
* 쓰레드가 0개가 되면 대기 시키거나 거절하여 서버가 죽을 일이 없음, 기존 요청은 처리 OK 
* 쓰레드가 미리 생성되어 있어, 쓰레드를 생성하고 종료하는 비용(CPU)가 절약되고, 응답 시간이 빠름 

### 해결책 2. 쓰레드 풀 실무 팁 
1. WAS의 주요 튜닝 포인트는 최대 쓰레드 수이다. 
2. 이 값을 너무 낮게 설정하면? 
> 요청이 많으면 WAS는 죽지 않았지만, 고객 서비스는 사실상 죽은 상태(응답 지연) 
3. 이 값을 너무 높게 설정하면? 
> 동시 요청이 많으면, CPU, 메모리 리소스 임계점 초과로 서버 다운 
4. 장애 발생시? 
* 클라우드면 일단 서버 증설, 이후에 튜닝
* 클라우드가 아니면 평상시에 열심히 튜닝.. 

### 해결책 2. 쓰레드 풀 적정 숫자 
1. 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다름! 
2. 성능 테스트 
* 최대한 실제 서비스와 유사하게 성능 테스트를 시도 해야함 
* 툴 : 아파치 ab, 제이미터, nGrinder 

### WAS의 멀티 쓰레드 지원 핵심 
1. 멀티 쓰레드에 대한 부분은 WAS가 처리 
2. 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨 
3. 개발자는 마치 싱글 쓰레드 프로그래밍 하듯이 편리하게 소스 코드를 개발 
4. 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용할 것  
> 공유 변수들 조심할 것..
